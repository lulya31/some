@startuml C2

!include static/includes/c4_context.puml
!include static/includes/c4_container.puml
!include static/includes/c4_component.puml

skinparam backgroundcolor transparent
skinparam minClassWidth 200
skinparam linetype ortho

skinparam nodesep 50
'skinparam Ranksep 60

'LAYOUT_LEFT_RIGHT()
LAYOUT_TOP_DOWN()

System(rolf, "[System]", "", $sprite="img:./static/06_01_img/rolf_logo_2020.png{scale=0.2}", $link="/06_c4_infrastructure/")
System_Ext(external_systems, "External systems", "[systems]")

System_Boundary(flora, "Система Flora", "Система Flora"){

    System_Boundary(frontend, "FrontEnd", "FrontEnd"){
        Container(asp_sell, "ASP sell", "VueJS, TypeScript")
        Container(crm, "CRM", "VueJS, TypeScript")
        Container(auto_card, "Auto card", "VueJS, TypeScript")
        Container(client_card, "Client card", "VueJS, TypeScript")
        Container(employee_card, "Employee card", "VueJS, TypeScript")
        Container(db_card, "DB card", "VueJS, TypeScript")
        Container(common_db_app, "Common DB app", "VueJS, TypeScript")
        Container(fi, "F&I", "VueJS, TypeScript")
        Container(frontendservice, "Service", "VueJS, TypeScript")
    }

    Container_Boundary(infra, "Infrastructure", ""){
        Container(apim, "APIM", "", $sprite="img:./static/06_01_img/leroy_logo.png{scale=0.05}")
        Container(centrifugo, "Centrifugo (WSS)", "", $sprite="img:./static/06_01_img/centrifugo_soc.png{scale=0.05}")
        Container(kafka, "Kafka", "", $sprite="img:./static/06_01_img/kafka_logo.png{scale=0.1}")
    }

    Container_Boundary(experience, "EXPERIENCE", "EXPERIENCE"){
        Container(service, "Service", "Platformeco")
        Container(f_and_i, "F&I", "Platformeco", $link="https://doc-fi-main.com-dev.int.rolfcorp.ru/01_overview/02_architecture/01_c4_logic_scheme/")
        Container(asp_and_na, "ASP & NA", "Platformeco")
        Container(mes, "MES", "Platformeco")
    }

    Container_Boundary(core, "CORE", "CORE"){
        Container(orders, "Orders", "Platformeco")
        Container(communications, "Communications", "Platformeco")
        Container(coreapp, "Coreapp", "Platformeco")
        Container(task_and_events, "Task and Events", "Platformeco")
        Container(rolfid, "RolfID", "Platformeco")
        Container(carid, "CarID", "Platformeco")
        Container(clientid, "ClientID", "Platformeco")
        Container(mdm, "MDM", "Platformeco")
        Container(external_integration, "External Integration", "Platformeco")
        Container(internal_integration, "Internal Integration", "Platformeco")
        Container(payments, "Payments", "Platformeco")
        Container(printservice, "Print service", "NodeJS")
        Container(printformsanalize, "Print forms analize", "NodeJS")
    }

    System_Boundary(infrastructure, "Infrastructure (DB, ETC)", "Infrastructure (DB, ETC)"){
        ContainerDb(postgresql, "", "", $sprite="img:./static/06_01_img/postgresql_logo.png{scale=0.4}")
        Container(s3_cep, "S3 Cep", "", $sprite="img:./static/06_01_img/s3_logo.png{scale=0.05}")
        ContainerDb(mongodb, "", "", $sprite="img:./static/06_01_img/mongodb_logo.png{scale=0.1}")
        Container(opensearch, "", "", $sprite="img:./static/06_01_img/opensearch_logo.png{scale=0.1}")
        Container(keycloak, "Keycloak", "", $sprite="img:./static/06_01_img/keycloak_logo.png{scale=0.2}")
        Container(grafana, "", "", $sprite="img:./static/06_01_img/grafana_logo.png{scale=0.05}")
    }
    
    Lay_D(employee_card, centrifugo)
    Lay_D(db_card, apim)
    Lay_D(fi, kafka)

    Lay_D(kafka, f_and_i)
    Lay_D(apim, asp_and_na)
    Lay_D(centrifugo, mes)
    Lay_D(mes, service)

    Lay_D(f_and_i, rolfid)
    Lay_D(asp_and_na, communications)
    Lay_D(service, orders)

    Lay_D(orders, mdm)
    Lay_D(communications, external_integration)
    Lay_D(coreapp, internal_integration)
    Lay_D(task_and_events, payments)
    Lay_D(rolfid, printservice)
    Lay_D(carid, printformsanalize)


    Lay_D(printformsanalize, grafana)
    Lay_D(mdm, postgresql)
    Lay_D(printservice, opensearch)
    Lay_D(internal_integration, s3_cep)
    Lay_D(external_integration, keycloak)
    Lay_D(payments, mongodb)

    BiRel_U(common_db_app, client_card, "")
    BiRel_U(common_db_app, crm, "")
    BiRel_U(common_db_app, auto_card, "")
    BiRel_U(common_db_app, asp_sell, "")
    BiRel_D(common_db_app, employee_card, "")
    BiRel_D(common_db_app, frontendservice, "")
    BiRel_D(common_db_app, fi, "")
    BiRel_D(common_db_app, db_card, "")

    BiRel_U(apim, frontend, "")
    BiRel_D(apim, experience, "")
    BiRel_D(apim, core, "")

    Rel(kafka, core, "")
    Rel(kafka, experience, "")

    BiRel(orders, opensearch, "")
    BiRel(communications, opensearch, "")
    BiRel(coreapp, opensearch, "")
    Rel(mes, service, "")
    BiRel(printservice, s3_cep, "")
    BiRel(f_and_i, opensearch, "")
    BiRel(rolfid, opensearch, "")
    BiRel(carid, opensearch, "")
    BiRel(clientid, opensearch, "")

    BiRel(postgresql, core, "")

    Rel_U(centrifugo, frontend, "")
    BiRel(centrifugo, task_and_events, "")
    BiRel_U(keycloak, rolfid, "")
}

Lay_D(external_integration, external_systems)
'Lay_D(rolf, auto_card)
Rel_D(rolf, flora, "")

Lay_D(flora, external_systems)
BiRel_D(external_integration, external_systems, "")

@enduml