---
title: "IDM KeyCloak"
description: "IDM KeyCloak"
weight: 1
draft: false
Categories:
    - Architecture
    - Backend
Tags:
    - Infrastructure
    - Idm key cloak
---

:imgdir: /02_02_04_01_img/
:imagesoutdir: ./static/02_02_04_01_img/

include::static/includes/init.adoc[]

:mermaid-puppeteer-config: ./themes/shadocs/puppeteer-config.json

= IDM KeyCloak

{empty} +

****
.Коллекция *Postman*
[[collection_postman_anchor]]
[%collapsible%close]
====
[source, json]
----
include::static/02_02_04_01_img/keycloak_postman_collection.json[]
----
====
****

== Досупы KeyCloak

****
[cols="^.^10,.^90"]
|===
| Окружение ^.^| URL

| Prod | `*link:https://keycloak.int.rolfcorp.ru/[window=_blank]*`
| Dev | `*link:https://keycloak.com-dev.int.rolfcorp.ru/[window=_blank]*`
|===
****

== IDM KeyCloak

****
*Keycloak* продукт с открытым кодом для реализации *single sign-on* с возможностью управления доступом, нацелен на современные приложения и сервисы. +
*Keycloak* используется в проекте *Rolf* совместно c link:/02_architecture/02_backend/01_databases/01_db_redis/[*Redis*, window=_blank] и link:/02_architecture/02_backend/05_internal_systems_rolf/01_active_directory/[*Active Directory*, window=_blank] для управления учетными записями.
****

== Keycloak
---

{empty} +

link:http://keycloak.jboss.org/[Keycloak, window=_blank] — это сервер аутентификации и управления учетными записями (*IDM*) от *JBoss*, построенный на базе спецификаций *OAuth 2.0*, *Open ID Connect*, *JSON Web Token (JWT)* и *SAML 2.0*.
Список возможностей KeyCloak достаточно большой и включает поддержку *SSO*, *Social Login*, интеграцию с *LDAP* серверами, управление пользователями, группами и ролями, и многе другое.

{empty} +

.Официальный логотип *KeyCloak*
****
image::keycloak-logo.jpeg[width=25%, align=center]
****

=== Как работает аутентификация в KeyCloak?

После этапа настройки приложения и KeyCloak сервера схема авторизации выглядит так:

{empty} +

[mermaid, target=keycloak, align=center]
....
%%{init: { 'securitylevel': 'loose', 'theme': 'base' }}%%

sequenceDiagram
    Пользователь/Browser ->> Видео PECT сервис: Шаг 1: Запрос защищенного ресурса.
    Видео PECT сервис ->> KeyCloak сервер: Шаг 2: Редирект на KeyCloak
    KeyCloak сервер -->> Пользователь/Browser: Шаг 3: Отображение страницы для аутентификации
    Пользователь/Browser ->> KeyCloak сервер: Шаг 4: Пользователь вводит логин и пароль
    KeyCloak сервер -->> Видео PECT сервис: Шаг 5: KeyCloak Возвращает временный токен
    Видео PECT сервис ->> KeyCloak сервер: Шаг 6: запрос JWT токена в обмен на временный
    KeyCloak сервер -->> Видео PECT сервис: Шаг 7: Возврат JWT токена
    Видео PECT сервис -->> Пользователь/Browser: Шаг 8: Отображение защищенного запроса
....

****
====
* Шаг 1: Запрос защищенного ресурса. Пользователь в браузере обращается по *URL* к закрытому ресурсу.
* Шаг 2: Закрытое приложение перенаправляет неавторизованного пользователя на сервер аутентификации *KeyCloak*.
* Шаг 3: *KeyCloak* отображает страницу аутентификации (логин/пароль, социальный логин, и т.д.).
* Шаг 4: Пользователь проходит этап аутентификации. Для простоты будем считать, что вводит логин и пароль.
* Шаг 5: *KeyCloak* выдает временный токен (секрет) и делает редирект на страницу защищенного приложения.
* Шаг 6 и Шаг 7: Приложение проверяет валидность временного токена и меняет временный на постоянный *JWT* токен.
* Шаг 8: На защищенном приложении проходит этап формирования контекста безопасности. Пользователю отображается защищенный ресурс.
====
****

=== JSON Web Token (JWT)

*JWT* (*JSON Web Token*) — link:https://tools.ietf.org/html/rfc7519[Открытый стандарт, window=_blank], который определяет компактный и автономный способ для защищенной передачи информации между сторонами в виде *JSON*-объекта.

{empty} +

*Основные свойства:*
****
. *Компактный* - В отличие от *SAML* сообщений (на основе *XML*), формат *JWT* выглядит намного проще.
. *Емкий* - Содержит информацию по аутентифицированному пользователю, включая роли.
. *Самодостаточный* - Для проверки токена не требуется обращаться к единому серверу (серверу *idP*, сервису *sts*). Эту проверку приложение может проводить самостоятельно, имея в наличии открытый ключ.
****

*Состоит из трех частей:*
****
. *Заголовок*
. *Основная информация*
. *Цифровая подпись*
****

Согласно стандарту токен состоит из трех частей в *base-64* формате, разделенных точками. Первая часть называется *заголовком* (*header*), в которой содержится тип токена и название хэш-алгоритма для получения цифровой подписи. Вторая часть хранит основную информацию (*пользователь*, *атрибуты*, *роли* и т.д.). Третья часть – *цифровая подпись*. Более детальную информацию можно посмотреть link:http://jwt.io/introduction/[тут, window=_blank].

{empty} +

---

{empty} +

====
IMPORTANT: Знаком icon:check-circle[role=green] отмечены активности которые *ВОЙДУТ* в MVP на МАРТ 2023 года!!! +
Знаком icon:minus-circle[role=red] отмечены активности которые *[red]#НЕ# ВОЙДУТ в* MVP на МАРТ 2023 года!!!
====

[[ID-4]]
== Задачи решаемые модулем ID-4 footnote:ID-4[Документ в Confluence ROLF: [blue]#*MVP Функционал Продукта One Rolf + MDM + MES + WMS|TMS (Новая версия Ноябрь 2022)*#, Название модуля системы: [blue]#*ID-4. Управление пользователями системы*#] по управлению пользователями системы

****
*Работа с базой пользователей*
[.green.background]
====
* Табличное отображение icon:check-circle[role=green]
====
[.red.background]
====
. Фильтрация по выбранным параметрам icon:minus-circle[role=red]
. Сортировка icon:minus-circle[role=red]
. Создание / Редактирование / Удаление рабочих групп icon:question-circle[role=blue]
====
****
****
*Работа с карточкой пользователя*
[.green.background]
====
. Получение и вывод данных о пользователе icon:check-circle[role=green]
. Привязка сотрудника к ДЦ icon:check-circle[role=green] (если нельзя ориентироваться на SAP) 
. Привязка сотрудника к отделу icon:check-circle[role=green] (если нельзя ориентироваться на SAP)
. Создание и редактирование рабочего графика пользователя icon:check-circle[role=green]
. Доверенность на продажу ТМЦ: создание именной доверенности и загрузка в КП icon:check-circle[role=green]
====
[.red.background]
====
. Редактирование части данных о пользователе  icon:minus-circle[role=red]
. Просмотр и редактирование ролей пользователя icon:minus-circle[role=red]
. Добавление пользователя в рабочие группы One Rolf icon:question-circle[role=blue]
====
****
****
*Права доступа One Rolf*
[.green.background]
====
. Создание и редактирование ролей доступа icon:check-circle[role=green]
. Добавление пользователя к одной или более роли icon:check-circle[role=green]
====
[.red.background]
====
. Реестр ролей One Rolf с указанием условий и соответствующих кодов должности icon:minus-circle[role=red]
. Просмотр всех пользователей в разрезе выбранной роли icon:minus-circle[role=red]
. Аттестация для доступа к выделенному модулю icon:minus-circle[role=red]
====
****
****
*Интеграции внешние и внутренние*
[.green.background]
====
. SAP HR icon:check-circle[role=green]
. AD (Active Directory) icon:check-circle[role=green]
. Web Сервис (графики мастеров) icon:check-circle[role=green]
====
[.red.background]
====
. ARMS icon:question-circle[role=blue]
. новый сервис распределения ролей: на MVP *AD* + *Keyclock* в итоговом продукте: пишем новый модуль в Onerolf icon:minus-circle[role=red]
. WEB Tutor icon:minus-circle[role=red]
. ССД icon:question-circle[role=blue]
====
****

[[SERV-1]]
== Задачи решаемые модулем SERV-1 footnote:SERV-1[Документ в Confluence ROLF: [blue]#*MVP Функционал Продукта One Rolf + MDM + MES + WMS|TMS (Новая версия Ноябрь 2022)*#, Название модуля системы: [blue]#*SERV-1. Авторизация | Личный кабинет*#] по управлению авторизацией и личным кабинетом

****
[.green.background]
====
* Авторизация и выход из системы icon:check-circle[role=green]
* КС глазами авторизованного пользователя. Просмотр своего профиля в котором указаны:
. ФИО icon:check-circle[role=green]
. Должность icon:check-circle[role=green]
. Руководитель icon:check-circle[role=green]
. Подчиненные icon:check-circle[role=green]
. Рабочие группы icon:check-circle[role=green]
. Город icon:check-circle[role=green]
. Локация icon:check-circle[role=green]
. ДЦ icon:check-circle[role=green]
. Рабочий день: активен, не активен icon:check-circle[role=green]
. Статус "Онлайн" / "Офлайн" icon:check-circle[role=green]
. Уведомления о новых задачах (браузер или веб пуши или альтернатива) icon:check-circle[role=green]
====
[.red.background]
====
* КС глазами авторизованного пользователя. Просмотр своего профиля в котором указаны:
. Уровень доступа в системе icon:minus-circle[role=red]
. Привязанные бренды icon:minus-circle[role=red]
. Статус: работает, отпуск, больничный, декрет, уволен. icon:minus-circle[role=red]
. Пройденные аттестации из Web Tutor icon:minus-circle[role=red]
. Добавление, редактирование и удаление фото в своём профиле. icon:minus-circle[role=red]
. Добавление, редактирование и удаление личного телефона в своём профиле. icon:minus-circle[role=red]
====
****
****
*Интеграции внешние и внутренние*
[.green.background]
====
. AD icon:check-circle[role=green]
. Sap HR icon:check-circle[role=green]
====
[.red.background]
====
* Web Tutor icon:minus-circle[role=red]
====
****