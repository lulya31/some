---
title: "Паттерн - Saga"
description: "Паттерн - Saga"
weight: 1
draft: false
Categories:
    - Architecture
    - Patterns    
Tags:
    - Saga
---

:imgdir: /04_03_01_img/
:imagesoutdir: ./static/04_03_01_img/

include::static/includes/init.adoc[]



= Паттерн - Saga

{empty} +

== Контекст

****
Вы применили link:/02_architecture/03_patterns/02_database_per_service/[шаблон базы данных на службу, window=_blank]. Каждый сервис имеет свою базу данных. Однако некоторые бизнес-транзакции охватывают несколько сервисов, поэтому вам нужен механизм для реализации транзакций, которые охватывают сервисы. Например, давайте представим, что вы строите магазин электронной коммерции, в котором у клиентов есть кредитный лимит. Приложение должно гарантировать, что новый заказ не превысит кредитный лимит клиента. Поскольку заказы и клиенты находятся в разных базах данных, принадлежащих разным службам, приложение не может просто использовать локальную транзакцию *ACID*.
****

== Проблема

****
Как реализовать транзакции, охватывающие сервисы?
****

== Преимущества

****
> *2PC* не вариант
****

== Решение

****
Реализуйте каждую бизнес-транзакцию, охватывающую несколько сервисов, в виде *Saga*. *Saga* — это последовательность локальных транзакций. Каждая локальная транзакция обновляет базу данных и публикует сообщение или событие, чтобы инициировать следующую локальную транзакцию в *Saga*-е. Если локальная транзакция терпит неудачу из-за нарушения бизнес-правила, *Saga* выполняет серию компенсирующих транзакций, которые отменяют изменения, внесенные предыдущими локальными транзакциями.
****

****
.Переход от *2PC* в *Saga*
[[from_2pc_to_saga_anchor]]
[%collapsible%open]
====
image::from_2pc_to_saga.png[title="Переход от *2PC* в *Saga*", align=center]
====
****

== Два способа согласования Saga

****
* *Хореография* — каждая локальная транзакция публикует события домена, которые запускают локальные транзакции в других службах.
* *Оркестрация* — оркестратор (объект) сообщает участникам, какие локальные транзакции выполнять.
****

=== Пример: Saga, основанная на хореографии

****
.*Saga*, основанная на хореографии
[[create_order_saga_anchor]]
[%collapsible%open]
====
image::create_order_saga.png[title="*Saga*, основанная на хореографии", align=center]
====
****

.*Приложение электронной коммерции, использующее этот подход, создаст заказ, используя основанную на хореографии Saga-у, состоящую из следующих шагов:*
****
. Получает `[.red]#*Order Service*#` запрос `[.red]#*POST /orders*#` и создает `[.red]#*Order*#` в `[.red]#*PENDING*#` состоянии
. Затем он генерирует `[.red]#*Order Created*#` событие
. Обработчик `[.red]#*Customer Service*#` события пытается зарезервировать кредит
. Затем он генерирует событие, указывающее результат
. Обработчик `[.red]#*OrderService*#` событий либо одобряет, либо отклоняетOrder
****

=== Пример: Saga на основе оркестровки

****
.*Saga*, на основе оркестровки
[[create_order_saga_orchestration_anchor]]
[%collapsible%open]
====
image::create_order_saga_orchestration.png[title="*Saga*, на основе оркестровки", align=center]
====
****


.*Приложение электронной коммерции, использующее этот подход, создаст заказ, используя Saga-у на основе оркестровки, состоящую из следующих шагов:*
****
. Получает `[.red]#*Order Service*#` запрос `[.red]#*POST/orders*#` и создает `[.red]#*Create Order*#` оркестратор *Saga*-и
. Оркестратор *Saga*-и создает `[.red]#*Order*#` в `[.red]#*PENDING*#` штате
. Затем он отправляет `[.red]#*Reserve Credit*#` команду на `[.red]#*Customer Service*#`
. Попытки `[.red]#*Customer Service*#` зарезервировать кредит
. Затем он отправляет обратно ответное сообщение с указанием результата
. Оркестратор *Saga*-и либо одобряет, либо отклоняет `[.red]#*Order*#`
****

== Результат

.*Этот шаблон имеет следующие преимущества:*
****
Это позволяет приложению поддерживать согласованность данных между несколькими службами без использования распределенных транзакций.
****

.*Это решение имеет следующие недостатки:*
****
* Модель программирования более сложная. Например, разработчик должен разработать компенсационные транзакции, которые явно отменяют изменения, сделанные ранее в *Saga*-е.
****

.*Также необходимо решить следующие вопросы:*
****
* Чтобы быть надежным, служба должна автоматически обновлять свою базу данных и публиковать сообщение/событие. Он не может использовать традиционный механизм распределенной транзакции, охватывающий базу данных и брокер сообщений. Вместо этого он должен использовать один из шаблонов, перечисленных ниже.

* Клиент, который инициирует *Saga*-у, которая представляет собой асинхронный поток с использованием синхронного запроса (например, `[.red]#*HTTP POST /orders*#`), должен иметь возможность определить его результат. Есть несколько вариантов, каждый со своими компромиссами:

** Служба отправляет ответ после завершения *Saga*-и, например, после получения события `[.red]#*OrderApproved*#` или `[.red]#*OrderRejected*#`.
** Служба отправляет ответ (например, содержащий `[.red]#*orderID*#`) после запуска саги, и клиент периодически опрашивает (например `[.red]#*GET /orders/{orderID}*#`), чтобы определить результат
** Служба отправляет ответ (например, содержащий `[.red]#*orderID*#`) после запуска саги, а затем отправляет событие (например, *Web*-сокет, *Web*-перехватчик и т. д.) клиенту после завершения саги.
****