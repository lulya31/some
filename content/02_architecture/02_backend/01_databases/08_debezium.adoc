---
title: "Debezium"
description: "Debezium"
weight: 8
draft: false
---

:imgdir: /02_02_01_08_img/
:imagesoutdir: ./static/02_02_01_08_img/

include::content/init.adoc[]

= Debezium

{empty} +

== Debezium и CDC

****
link:https://debezium.io/[*Debezium*, window=_blank] - это распределенная платформа, которая преобразует информацию из ваших существующих баз данных в потоки событий, позволяя приложениям обнаруживать и немедленно реагировать на изменения данных на уровне строк в базах данных. +
*Debezium* построен на основе *Apache Kafka* и предоставляет набор совместимых с *Kafka Connect* коннекторов. Каждый из коннекторов работает с определенной базой данных (*СУБД*). Коннекторы записывают историю изменений данных в *СУБД*, обнаруживая изменения по мере их возникновения и отправляя запись о каждом событии изменения в *Kafka*. Затем потребляющие приложения могут считывать результирующие записи событий из *Kafka*.
****

****
Используя преимущества надежной потоковой платформы *Kafka*, *Debezium* позволяет приложениям правильно и полностью использовать изменения, происходящие в базе данных. Даже если ваше приложение неожиданно остановится или потеряет соединение, оно не пропустит события, происходящие во время простоя. После перезапуска приложение возобновляет чтение темы с того места, где оно было остановлено.
****

****
*Debezium* - это link:https://github.com/debezium/debezium[Open Source-проект, window=_blank], использующий лицензию *Apache License v2.0* и спонсируемый компанией *Red Hat*. Разработка ведётся с *2016* года и сейчас в нем представлена официальная поддержка следующих *СУБД*:

{empty} +

====
* link:https://debezium.io/documentation/reference/stable/connectors/cassandra.html#debezium-connector-for-cassandra[*Cassandra*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/db2.html#debezium-connector-for-db2[*Db2*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/mongodb.html#debezium-connector-for-mongodb[*MongoDB*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/mysql.html#debezium-connector-for-mysql[*MySQL*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/oracle.html#debezium-connector-for-oracle[*Oracle*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/postgresql.html#debezium-connector-for-postgresql[*PostgreSQL*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/sqlserver.html#debezium-connector-for-sql-server[*SQL Server*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/vitess.html#debezium-connector-for-vitess[*Vitess*, window=_blank]
====
****

****
Если сравнивать *CDC* с традиционным подходом (когда приложение читает данные из *СУБД* напрямую), то к его главным преимуществам относят реализацию стриминга изменения данных на уровне строк с низкой задержкой, высокой надежностью и доступностью. Последние два пункта достигаются благодаря использованию кластера *Kafka* в качестве хранилища *CDC*-событий.
****

****
Также к достоинствам можно отнести тот факт, что для хранения событий используется единая модель, поэтому конечному приложению не придётся беспокоиться о нюансах эксплуатации различных *СУБД*.
****

****
Наконец, благодаря использованию брокера сообщений открывается простор для горизонтального масштабирования приложений, отслеживающих изменения в данных. При этом влияние на источник данных сводится к минимуму, поскольку получение данных происходит не напрямую из *СУБД*, а из кластера *Kafka*.
****

== Архитектура Debezium

****
Чаще всего *Debezium* разворачивается с помощью *Apache Kafka Connect*. *Kafka Connect* — это платформа и среда выполнения следующих задач:

{empty} +

====
* Коннекторы, такие как *Debezium*, которые отправляют записи в *Kafka*
* Коннекторы приемника, которые распределеют записи из топиков *Kafka* в другие системы.
====

На link:#debezium_anchor[рисунке 1] показана архитектура конвейера отслеживания измененных данных на основе *Debezium*.
****

****
.Архитектура *Debezium*
[[debezium_anchor]]
[%collapsible%open]
====
image::debezium.png[title="Архитектура *Debezium*", align=center]
====
****

****
Как показано на рисунке, коннекторы *Debezium* для *MySQL* и *PostgresSQL* регистрирует изменения в этих двух базах данных. Каждый коннектор *Debezium* устанавливает соединение со своей исходной базой данных:

{empty} +

====
* Коннектор *MySQL* использует клиентскую библиотеку для доступа к *binlog*.
* Коннектор *PostgreSQL* читает из логического потока репликации.
====

*Kafka Connect* работает как отдельная служба помимо брокера *Kafka*. По умолчанию изменения из одной таблицы базы данных записываются в топик *Kafka*, имя которого соответствует имени таблицы. При необходимости вы можете изменить имя темы назначения, настроив преобразование маршрутизации темы *Debezium*. +
Например, вы можете:

{empty} +

====
* Направлять записи в тему, имя которой отличается от имени таблицы
* Потоковое изменение записей событий для нескольких таблиц в одну тему
====

После того, как записи об изменениях находятся в *Apache Kafka*, разные коннекторы в экосистеме *Kafka Connect* могут передавать записи в другие системы и базы данных, такие как *Elasticsearch*, хранилища данных и системы аналитики или кэши, такие как *Infinispan*. В зависимости от выбранного соединителя приемника вам может потребоваться настроить новое преобразование *Debezium* для извлечения состояния записи.
****

=== Сервер Debezium

****
Другой способ развертывания *Debezium* — использование сервера *Debezium*. Сервер *Debezium* — это настраиваемое, готовое к использованию приложение, которое передает события изменений из исходной базы данных в различные инфраструктуры обмена сообщениями. +
На link:#debezium_2_anchor[рисунке 2] показана архитектура конвейера отслеживания измененных данных, который использует сервер *Debezium*.
****

****
.Сервер *Debezium*
[[debezium_2_anchor]]
[%collapsible%open]
====
image::debezium_2.png[title="Сервер *Debezium*", align=center]
====
****

****
Сервер *Debezium* настроен на использование одного из исходных коннекторов *Debezium* для захвата изменений из исходной базы данных. События изменений могут быть сериализованы в различные форматы, такие как *JSON* или *Apache Avro*, а затем отправлены в одну из множества инфраструктур обмена сообщениями, таких как *Amazon Kinesis*, *Google Cloud Pub/Sub* или *Apache Pulsar*.
****

== Коннекторы

****
Цель *Debezium* — создать библиотеку коннекторов, которые перехватывают изменения из различных баз данных и создают события с очень похожей структурой, что значительно упрощает приложениям фиксировать информацию о произошедших изменениях в базах данных и осуществлять соответствующую реакцию на это.

{empty} +

На данный момент у нас есть следующие коннекторы:

{empty} +

====
* link:https://debezium.io/documentation/reference/stable/connectors/mongodb.html[*MongoDB*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/mysql.html[*MySQL*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/postgresql.html[*PostgreSQL*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/sqlserver.html[*SQL Server*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/oracle.html[*Oracle*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/db2.html[*Db2*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/cassandra.html[*Cassandra*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/vitess.html[*Vitess (Incubating)*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/spanner.html[*Spanner (Incubating)*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/jdbc.html[*JDBC (Incubating)*, window=_blank]
====
****

====
NOTE: *Инкубационный коннектор* ([.blue]#*Incubating*#) — это коннектор, выпущенный для ознакомления с изменениями, которые не всегда могут быть обратно совместимыми.
====

== Преобразования

****
Для Коннекторов можно настроить преобразователи которые при получении модифицируют сообщения. *Debezium* предоставляет несколько преобразований одиночных сообщений (*SMT*), которые можно использовать либо для изменения записей перед их отправкой в *​​Apache Kafka* (применяя их к коннекторам *Debezium*), либо когда они считываются из *Kafka* коннектором приемника. Также *Debezium Server* поддерживает использование *SMT*.
****

****
*Debezium* предоставляет следующие *SMT*:

[cols=".^30,.^70"]
|===
^.^| Трансформировать ^.^| Описание

| link:https://debezium.io/documentation/reference/stable/transformations/topic-routing.html[*Topic Routing*, window=_blank] | Перенаправляет записи в другие темы на основе регулярного выражения, примененного к исходному названию темы.
| link:https://debezium.io/documentation/reference/stable/transformations/content-based-routing.html[*Content-Based Routing*, window=_blank] | Перенаправлять выбранные события на другие темы в зависимости от содержания события.
| link:https://debezium.io/documentation/reference/stable/transformations/event-flattening.html[*New Record State Extraction*, window=_blank] | Извлекает плоскую структуру имен полей и значений из событий изменений *Debezium*, упрощая коннекторы приемников, которые не могут обрабатывать сложную структуру событий *Debezium*.
| link:https://debezium.io/documentation/reference/stable/transformations/mongodb-event-flattening.html[*MongoDB New Document State Extraction*, window=_blank] | Специфичный для *MongoDB* аналог link:https://debezium.io/documentation/reference/stable/transformations/event-flattening.html[*новой SMT извлечения состояния записи*, window=_blank].
| link:https://debezium.io/documentation/reference/stable/transformations/outbox-event-router.html[*Outbox Event Router*, window=_blank] | Предоставляет способ безопасного и надежного обмена данными между несколькими (микро) службами.
| link:https://debezium.io/documentation/reference/stable/transformations/mongodb-outbox-event-router.html[*MongoDB Outbox Event Router*, window=_blank] | Специфичный для *MongoDB* аналог маршрутизатора link:https://debezium.io/documentation/reference/stable/transformations/outbox-event-router.html[*исходящих событий*, window=_blank] *SMT*.
| link:https://debezium.io/documentation/reference/stable/transformations/filtering.html[*Message Filtering*, window=_blank] | Применяет фильтр к событиям изменения, создаваемым соединителями, на основе их содержимого. Это позволяет вам распространять только те записи, которые имеют отношение к вам.
| link:https://debezium.io/documentation/reference/stable/transformations/compute-partition.html[*Compute Partition*, window=_blank] | Перенаправляет записи в определенный раздел на основе настроенного столбца таблицы.
| link:https://debezium.io/documentation/reference/stable/transformations/header-to-value.html[*HeaderToValue*, window=_blank] | Перемещает или копирует заголовки в значение записи.
| link:https://debezium.io/documentation/reference/stable/transformations/partition-routing.html[*Partition Routing*, window=_blank] | 	
Перенаправляет записи в определенные разделы на основе настроенных полей полезной нагрузки.
|===
****

****
С помощью link:https://debezium.io/documentation/reference/stable/transformations/applying-transformations-selectively.html[*предикатов SMT*, window=_blank] можно выборочно применять любые преобразования, чтобы они изменяли только то подмножество сообщений об изменениях, которые имеют общие характеристики.
****

====
NOTE: Большинство из вышеперечисленных *SMT* доступны по умолчанию с образом контейнера *Debezium*, но вам необходимо выбрать использование сценариев на основе сценариев (фильтрация сообщений или маршрутизация на основе содержимого). Дополнительные сведения см. в файле link:https://github.com/debezium/container-images/tree/main/connect/1.7#enable_debezium_scripting[*README*, window=_blank] образа контейнера.
====

== Движек Debezium

****
Коннекторы *Debezium* обычно управляются путем их развертывания в службе *Kafka Connect* и настройки одного или нескольких коннекторов для мониторинга баз данных и создания событий изменения данных для всех изменений, которые они видят в базах данных. Эти события изменения данных записываются в *Kafka*, где они могут независимо использоваться многими различными приложениями. *Kafka Connect* обеспечивает превосходную отказоустойчивость и масштабируемость, поскольку работает как распределенная служба и гарантирует, что все зарегистрированные и настроенные коннекторы всегда работают. Например, даже если одна из конечных точек *Kafka Connect* в кластере выйдет из строя, оставшиеся конечные точки *Kafka Connect* перезапустят все коннекторы, которые ранее работали на отключенной конечной точке, минимизируя время простоя и устраняя административные действия.

{empty} +

Не каждому приложению нужен такой уровень отказоустойчивости и надежности, и они могут не захотеть полагаться на внешний кластер брокеров *Kafka* и сервисы *Kafka Connect*. Вместо этого некоторые приложения предпочитают встраивать коннекторы *Debezium* непосредственно в пространство приложения. Им по-прежнему нужны одни и те же события изменения данных, но они предпочитают, чтобы коннекторы отправляли их непосредственно в приложение, а не сохраняли их внутри *Kafka*.

{empty} +

*debezium-api* модуль предоставляет *API*, который позволяет приложению легко настраивать и запускать коннекторы *Debezium* с помощью *Debezium Engine*.
****

== Логирование

****
В коннекторы *Debezium* встроен механизм link:https://debezium.io/documentation/reference/stable/operations/logging.html[*логирования*, window=_blank] (ведения журнала). Также имеется возможность изменить конфигурацию ведения журнала. *Debezium* (а также *Kafka*, *Kafka Connect* и *Zookeeper*) используют среду ведения журналов link:https://logging.apache.org/log4j/1.2/[*Log4j*, window=_blank] для *Java*.

{empty} +

По умолчанию коннекторы при запуске создают довольно много полезной информации, но затем создают очень мало журналов, когда коннектор синхронизован с исходной базой данных. Этого часто достаточно, когда коннектор работает нормально, но может быть недостаточно, когда коннектор работает со сбоями. В таких случаях можно изменить уровень ведения журнала, чтобы коннектор генерировал гораздо более подробные сообщения журнала.
****

=== Концепция логирования

.Loggers
****
Каждое сообщение журнала, создаваемое приложением, отправляется определенному регистратору (например, *io.debezium.connector.mysql*). Регистраторы расположены иерархически. Например, *io.debezium.connector.mysql* регистратор является дочерним элементом регистратора *io.debezium.connector*, который является дочерним элементом регистратора *io.debezium*. На вершине иерархии корневой регистратор определяет конфигурацию регистратора по умолчанию для всех регистраторов ниже него.
****

.Log levels (уровни логирования)
****
Каждое сообщение журнала, созданное приложением, также имеет определенный уровень журнала:

{empty} +

====
* *ERROR* - Ошибки, исключения и другие существенные проблемы
* *WARN* - Возможные проблемы и вопросы
* *INFO* - Статус и общая активность (обычно малообъемная)
* *DEBUG* - Более подробные действия, которые были бы полезны при диагностике неожиданного поведения
* *TRACE* - Подробная информация (обычно очень объемная)
====
****

.Appenders
****
*Appender* — это _пункт назначения_, куда записываются сообщения журнала. Каждое приложение управляет форматом своих сообщений журнала, что дает вам еще больший контроль над тем, как выглядят сообщения журнала.

{empty} +

Чтобы настроить ведение журнала, вы указываете желаемый уровень для каждого регистратора и приложения, в которые должны записываться эти сообщения журнала. Поскольку регистраторы являются иерархическими, конфигурация корневого регистратора используется по умолчанию для всех регистраторов ниже него, хотя вы можете переопределить любой дочерний (или потомковый) регистратор.
****

== Мониторинг

****
Вы можете использовать метрики *JMX*, предоставляемые *Apache Zookeeper*, *Apache Kafka* и *Kafka Connect*, для мониторинга *Debezium*. Чтобы использовать эти метрики, вы должны включить их при запуске служб *Zookeeper*, *Kafka* и *Kafka Connect*. Включение *JMX* включает установку правильных переменных среды. Переменные среды, которые необходимо установить, зависят от того, используете ли вы *Zookeeper*, *Kafka* и *Kafka Connect* в локальной установке или в контейнерах *Docker*.
****

====
NOTE: Если вы запускаете несколько служб на одном компьютере, обязательно используйте разные порты *JMX* для каждой службы.
====

=== Метрики для мониторинга коннекторов Debezium

****
Помимо встроенной поддержки метрик *JMX* в *Kafka*, *Zookeeper* и *Kafka Connect*, каждый коннектор предоставляет дополнительные метрики, которые можно использовать для мониторинга их действий.

{empty} +

====
* link:https://debezium.io/documentation/reference/stable/connectors/db2.html#db2-monitoring[*Db2 connector metrics*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/mongodb.html#mongodb-monitoring[*MongoDB connector metrics*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/mysql.html#mysql-monitoring[*MySQL connector metrics*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/oracle.html#oracle-monitoring[*Oracle connector metrics*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/postgresql.html#postgresql-monitoring[*PostgreSQL connector metrics*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/sqlserver.html#sqlserver-monitoring[*SQL Server connector metrics*, window=_blank]
* link:https://debezium.io/documentation/reference/stable/connectors/cassandra.html#cassandra-monitoring[*Cassandra connector metrics*, window=_blank]
====
****